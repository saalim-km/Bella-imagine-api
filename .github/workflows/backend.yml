name: CI/CD to GCP VM

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to EC2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.GCP_VM_HOST  }}
          username: ${{ secrets.GCP_VM_USER  }}
          key: ${{ secrets.GCP_VM_SSH_KEY  }}
          script: |
            cd ~/Bella-imagine-api

            echo "Pulling latest changes from main branch..."
            git pull origin main

            echo "Installing dependencies..."
            npm install

            echo "Building TypeScript files..."
            npm run build

            echo "Restarting the application using PM2..."
            pm2 restart all || pm2 start dist/index.js --name "bella-imagine-api"

            echo "Deployment completed successfully."